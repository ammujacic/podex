name: Infrastructure Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'infrastructure/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'infrastructure/**'

jobs:
  test-infrastructure:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install uv
      uses: astral-sh/setup-uv@v4
      with:
        enable-cache: true
        cache-dependency-glob: "infrastructure/pyproject.toml"

    - name: Install dependencies
      run: |
        cd infrastructure
        uv sync --extra dev

    - name: Run Pulumi tests
      run: |
        cd infrastructure
        uv run pytest tests/ -v --tb=short

    - name: Run Pulumi preview (dry-run)
      run: |
        cd infrastructure
        # Only run preview if GCP credentials are available
        if [ -n "$GOOGLE_CREDENTIALS" ]; then
          pulumi login --local
          pulumi stack select dev --create
          pulumi preview --diff
        else
          echo "Skipping Pulumi preview - no GCP credentials available"
        fi
      env:
        GOOGLE_CREDENTIALS: ${{ secrets.GCP_SA_KEY }}
        PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
      continue-on-error: true  # Don't fail if credentials aren't available

  validate-pulumi-config:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Validate Pulumi configuration
      run: |
        cd infrastructure
        # Check if Pulumi.yaml is valid YAML
        python3 -c "import yaml; yaml.safe_load(open('Pulumi.yaml'))"
        python3 -c "import yaml; yaml.safe_load(open('Pulumi.dev.yaml'))"

        # Check Python syntax
        python3 -m py_compile __main__.py
        for stack in stacks/*.py; do
          python3 -m py_compile "$stack"
        done

        echo "âœ… Pulumi configuration validation passed"
